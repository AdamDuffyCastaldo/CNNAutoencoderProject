---
phase: 05-inference
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - scripts/sarcodec.py
autonomous: true

must_haves:
  truths:
    - "CLI accepts compress and decompress subcommands"
    - "Compress reads GeoTIFF, outputs NPZ with embedded metadata"
    - "Decompress reads NPZ, outputs GeoTIFF with preserved georeferencing"
    - "Progress bar shows ETA during processing"
    - "Exit codes distinguish success from different failure types"
  artifacts:
    - path: "scripts/sarcodec.py"
      provides: "CLI entry point"
      contains: "argparse"
  key_links:
    - from: "scripts/sarcodec.py"
      to: "src/inference/compressor.py"
      via: "SARCompressor usage"
      pattern: "from src.inference import SARCompressor"
    - from: "scripts/sarcodec.py"
      to: "src/inference/geotiff.py"
      via: "read_geotiff, write_geotiff"
      pattern: "from src.inference.geotiff import"
---

<objective>
Implement the CLI interface for SAR image compression and decompression.

Purpose: Provide user-friendly command-line tools for compressing raw Sentinel-1 GeoTIFFs and decompressing back to GeoTIFF format.

Output: `scripts/sarcodec.py` with compress/decompress subcommands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-inference/05-RESEARCH.md
@.planning/phases/05-inference/05-CONTEXT.md
@.planning/phases/05-inference/05-02-SUMMARY.md
@.planning/phases/05-inference/05-03-SUMMARY.md

# Key decisions from CONTEXT.md:
# - Single script with subcommands: sarcodec compress / sarcodec decompress
# - NPZ format for compressed output (includes geo metadata)
# - Progress bar with ETA (rich library)
# - Default model path with --model override
# - Exit codes: 0=success, 1=file error, 2=model error, 3=OOM
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CLI with argparse subcommands</name>
  <files>scripts/sarcodec.py</files>
  <action>
Create `scripts/sarcodec.py` with the following structure:

**Imports:**
- argparse, sys, json, hashlib
- rich.progress (Progress, SpinnerColumn, TextColumn, BarColumn, TimeRemainingColumn)
- src.inference (SARCompressor)
- src.inference.geotiff (read_geotiff, write_geotiff, write_cog, GeoMetadata)
- numpy

**CLI Structure:**
```
sarcodec --version
sarcodec compress INPUT [-o OUTPUT] [--model PATH] [--overlap N] [--batch-size N]
sarcodec decompress INPUT [-o OUTPUT] [--tiff-compress TYPE] [--cog]
```

**create_parser() -> argparse.ArgumentParser**
- Main parser with --version flag
- Subparsers for compress/decompress

**compress subcommand arguments:**
- input: positional, nargs='+' (multiple files)
- -o/--output: optional output path (default: auto-name as .npz)
- --model: model checkpoint path (default: notebooks/checkpoints/resnet_lite_v2_c16/best.pth)
- --overlap: tile overlap in pixels (default: 64)
- --batch-size: tiles per batch (default: auto-detect)

**decompress subcommand arguments:**
- input: positional, nargs='+' (multiple files)
- -o/--output: optional output path (default: auto-name as .tif)
- --tiff-compress: TIFF compression (default: lzw, choices: lzw, deflate, none)
- --cog: flag to output as Cloud Optimized GeoTIFF
- --model: model checkpoint path (needed for decoder)

**show_version()**
- Print tool version (1.0.0)
- Print model path and checkpoint hash (MD5 of first 1KB)
- Print torch/CUDA info

**Exit codes:**
- EXIT_SUCCESS = 0
- EXIT_FILE_ERROR = 1
- EXIT_MODEL_ERROR = 2
- EXIT_OOM_ERROR = 3
- EXIT_GENERAL_ERROR = 4

**main()**
- Parse args
- Route to compress_command() or decompress_command()
- Handle exceptions with appropriate exit codes
  </action>
  <verify>
Run: `python scripts/sarcodec.py --help`
Expected: Help output showing compress/decompress subcommands
  </verify>
  <done>
- CLI parses arguments correctly
- Help text is clear and complete
- Version flag works
- Subcommand structure is correct
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement compress and decompress commands</name>
  <files>scripts/sarcodec.py</files>
  <action>
Add the command implementations to `scripts/sarcodec.py`:

**compress_command(args) -> int**
1. Validate input files exist
2. Load model (catch errors -> EXIT_MODEL_ERROR)
3. For each input file:
   - Read GeoTIFF with read_geotiff()
   - Get nodata mask
   - Handle single-band (squeeze to 2D)
   - Create SARCompressor with model
   - Show rich progress bar during compress
   - Build metadata dict including:
     - geo_metadata: serialize GeoMetadata (CRS as WKT string, transform as tuple)
     - tile_metadata: from compress()
     - original_dtype: str
     - nodata_mask: optional (if nodata present)
   - Save to NPZ: np.savez_compressed(output, latent=latent, metadata=json.dumps(metadata))
   - Print summary: compression ratio, output size, time

**decompress_command(args) -> int**
1. Validate input files exist
2. Load model (for decoder)
3. For each input file:
   - Load NPZ
   - Parse metadata from JSON
   - Reconstruct GeoMetadata from serialized form
   - Show rich progress bar during decompress
   - Apply nodata mask if present
   - Write output with write_geotiff() or write_cog()
   - Print summary: output size, time

**Progress bar integration:**
```python
def create_progress_callback(progress, task):
    def callback(current, total):
        progress.update(task, completed=current)
    return callback
```

Use rich Progress context manager:
```python
with Progress(
    SpinnerColumn(),
    TextColumn("[bold blue]{task.description}"),
    BarColumn(),
    TextColumn("{task.completed}/{task.total}"),
    TimeRemainingColumn(),
) as progress:
    task = progress.add_task("Compressing...", total=total_batches)
    compressor.compress(image, progress_callback=create_progress_callback(progress, task))
```

**Error handling:**
- FileNotFoundError -> EXIT_FILE_ERROR
- torch.cuda.OutOfMemoryError -> EXIT_OOM_ERROR (retry with smaller batch once)
- RuntimeError from model load -> EXIT_MODEL_ERROR
- Other exceptions -> EXIT_GENERAL_ERROR with traceback
  </action>
  <verify>
Run: `python scripts/sarcodec.py compress --help`
Expected: Help output for compress subcommand with all options
  </verify>
  <done>
- compress_command processes GeoTIFF to NPZ
- decompress_command processes NPZ to GeoTIFF
- Progress bars show during processing
- Exit codes reflect error types
- Metadata preserved through round-trip
  </done>
</task>

</tasks>

<verification>
1. `python scripts/sarcodec.py --version` - shows version and model info
2. `python scripts/sarcodec.py compress --help` - shows compress options
3. `python scripts/sarcodec.py decompress --help` - shows decompress options
4. Exit codes work: `python scripts/sarcodec.py compress nonexistent.tif; echo $?` returns 1
</verification>

<success_criteria>
- CLI has compress and decompress subcommands
- Help text is clear and complete
- Progress bars show during processing
- Exit codes distinguish error types
- Version flag shows useful info
</success_criteria>

<output>
After completion, create `.planning/phases/05-inference/05-04-SUMMARY.md`
</output>
