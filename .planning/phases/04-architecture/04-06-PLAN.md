---
phase: 04-architecture
plan: 06
type: execute
wave: 4
depends_on: ["04-04", "04-05"]
files_modified:
  - notebooks/compare_architectures.ipynb
  - .planning/STATE.md
autonomous: false

must_haves:
  truths:
    - "All four models (Baseline, ResNet-Lite, Residual, Attention) compared in same evaluation"
    - "Visual comparison gallery shows all variants side-by-side"
    - "Rate-distortion style comparison documented"
    - "Phase success criteria assessed"
  artifacts:
    - path: "notebooks/compare_architectures.ipynb"
      provides: "Comprehensive architecture comparison"
    - path: ".planning/STATE.md"
      provides: "Updated project state with Phase 4 results"
  key_links:
    - from: "notebooks/compare_architectures.ipynb"
      to: "notebooks/checkpoints/*/best.pth"
      via: "loads all trained checkpoints"
      pattern: "torch.load.*best.pth"
---

<objective>
Create comprehensive comparison of all architecture variants and assess Phase 4 success criteria.

Purpose: Consolidate training results into a unified comparison, assess whether phase goals were met, and update project state for the next phase.

Output: Comparison notebook with visual gallery and metrics table, updated STATE.md with Phase 4 results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-architecture/04-CONTEXT.md
@.planning/phases/04-architecture/04-04-SUMMARY.md
@.planning/phases/04-architecture/04-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Architecture Comparison Notebook</name>
  <files>notebooks/compare_architectures.ipynb</files>
  <action>
Create `notebooks/compare_architectures.ipynb` with:

**1. Setup and Model Loading:**
```python
models = {
    'Baseline': ('checkpoints/baseline_c16_fast/best.pth', SARAutoencoder),
    'ResNet-Lite v2': ('checkpoints/resnet_lite_v2_c16/best.pth', ResNetAutoencoder),
    'Residual v1': ('checkpoints/residual_v1_c16/best.pth', ResidualAutoencoder),
    'Attention v1': ('checkpoints/attention_v1_c16/best.pth', AttentionAutoencoder),
}
```
Load all available checkpoints.

**2. Unified Evaluation:**
- Use same validation data for all models
- Compute for each model:
  - PSNR, SSIM, MSE (from CombinedLoss)
  - ENL ratio (from src.evaluation.metrics)
  - EPI (edge preservation index)
  - Parameter count

**3. Metrics Summary Table:**
```
| Model          | Params   | PSNR    | SSIM   | ENL     | EPI   | vs Base |
|----------------|----------|---------|--------|---------|-------|---------|
| Baseline       | 2.3M     | 20.47   | 0.646  | -       | -     | -       |
| ResNet-Lite v2 | 5.6M     | 21.20   | 0.726  | 0.851   | 0.876 | +0.73   |
| Residual v1    | ???      | ???     | ???    | ???     | ???   | +???    |
| Attention v1   | ???      | ???     | ???    | ???     | ???   | +???    |
```

**4. Visual Comparison Gallery:**
For 3-4 sample patches, create side-by-side comparison:
- Row per model: Original | Reconstruction | Difference
- Same color scale across all models for fair comparison
- Annotate with PSNR/SSIM for that patch

**5. Efficiency Analysis:**
- Parameters vs PSNR scatter plot
- Training time comparison (if available)
- PSNR gain per million parameters

**6. Phase 4 Success Criteria Assessment:**
From ROADMAP.md:
1. ResidualBlock forward pass preserves dimensions - PASS/FAIL
2. CBAM applies attention without errors - PASS/FAIL
3. Residual architecture >= +1.5 dB over baseline (target 22.0 dB) - PASS/FAIL
4. Attention architecture >= +0.5 dB over Residual - PASS/FAIL
5. ENL ratio 0.8-1.2 for all variants - PASS/FAIL (CONTEXT.md allows 0.7-1.3)

**7. Recommendations:**
- Best model for Phase 5 (Full Image Inference)
- Whether to proceed or iterate on architecture
  </action>
  <verify>
Notebook executes without errors and produces:
1. Metrics table with all models
2. Visual comparison figures saved
3. Phase 4 assessment documented
  </verify>
  <done>Comparison notebook created with unified evaluation, visual gallery, and phase assessment.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 4 architecture comparison showing:
- Pre-activation residual blocks and CBAM implementations
- Trained Variant B (Residual) and Variant C (Attention) models
- Metrics comparison across all four model variants
- Visual reconstruction gallery
  </what-built>
  <how-to-verify>
1. Open notebooks/compare_architectures.ipynb
2. Review the metrics summary table:
   - Verify Residual v1 PSNR is documented
   - Verify Attention v1 PSNR is documented
   - Check ENL ratios are in acceptable range (0.7-1.3)
3. Review the visual comparison gallery:
   - Confirm reconstructions look reasonable (no major artifacts)
   - Compare quality visually between variants
4. Review Phase 4 success criteria assessment:
   - Note which criteria passed/failed
   - If targets not met, note the actual values achieved
5. Confirm recommendation for Phase 5
  </how-to-verify>
  <resume-signal>Type "approved" to proceed with STATE.md update, or describe any issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Update Project State</name>
  <files>.planning/STATE.md</files>
  <action>
Update `.planning/STATE.md` with Phase 4 results:

**1. Current Position:**
- Update phase to 4 of 7 (Architecture Enhancement) - COMPLETE
- Update progress bars

**2. Performance Metrics:**
Add rows for new models:
```
| Model          | Params | Best PSNR | Best SSIM | Notes |
|----------------|--------|-----------|-----------|-------|
| Baseline       | 2.3M   | 20.47 dB  | 0.646     | Plain CNN |
| ResNet-Lite v2 | 5.6M   | 21.20 dB  | 0.726     | Post-activation |
| Residual v1    | ???    | ??? dB    | ???       | Pre-activation |
| Attention v1   | ???    | ??? dB    | ???       | Pre-act + CBAM |
```

**3. Key Decisions:**
Add new decisions:
- Pre-activation vs post-activation residual blocks
- CBAM placement (after every block)
- Loss weight adjustment (0.7 MSE + 0.3 SSIM)

**4. Technical Notes:**
- Best model for Phase 5
- ENL ratio findings
- Memory considerations for Attention model

**5. Next Session:**
- Priority: Execute Phase 5 (Full Image Inference)
- Command: `/gsd:plan-phase 05-inference`
- Context needed: Best model checkpoint path

**6. Quick Reference:**
Add new checkpoints:
- Residual v1: `notebooks/checkpoints/residual_v1_c16/best.pth`
- Attention v1: `notebooks/checkpoints/attention_v1_c16/best.pth`
  </action>
  <verify>
STATE.md updated with:
- Phase 4 marked complete
- New model metrics added
- Best model for Phase 5 documented
  </verify>
  <done>STATE.md updated with Phase 4 results, new model checkpoints documented, ready for Phase 5.</done>
</task>

</tasks>

<verification>
Phase 4 complete when:

1. Comparison notebook exists and runs
2. All models evaluated with same metrics
3. Visual comparison gallery generated
4. Phase success criteria assessed (PASS/FAIL documented)
5. STATE.md updated with results
6. Best model for Phase 5 identified
</verification>

<success_criteria>
1. All four models (Baseline, ResNet-Lite, Residual, Attention) compared in unified evaluation
2. Metrics table includes PSNR, SSIM, ENL ratio, EPI, parameter count
3. Visual comparison shows reconstructions from all variants
4. Phase 4 success criteria formally assessed
5. STATE.md updated with Phase 4 completion
6. Recommendation for Phase 5 documented
7. Human verification of results passed
</success_criteria>

<output>
After completion, create `.planning/phases/04-architecture/04-06-SUMMARY.md`
</output>
