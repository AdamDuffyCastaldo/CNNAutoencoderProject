---
phase: 06-final-experiments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - notebooks/checkpoints/resnet_c64_b64_cr4x_*/best.pth
  - notebooks/checkpoints/resnet_c32_b64_cr8x_*/best.pth
  - configs/sweep_resnet_ratios.yaml
autonomous: true

must_haves:
  truths:
    - "Baseline models at 4x, 8x, 16x verified to exist with reasonable PSNR"
    - "ResNet model trained at 4x compression exists with val PSNR > 20 dB"
    - "ResNet model trained at 8x compression exists with val PSNR > 20 dB"
    - "Training completed without CUDA OOM errors"
  artifacts:
    - path: "notebooks/checkpoints/baseline_c64_b64_cr4x_*/best.pth"
      provides: "Verified Baseline 4x checkpoint"
    - path: "notebooks/checkpoints/baseline_c32_b64_cr8x_*/best.pth"
      provides: "Verified Baseline 8x checkpoint"
    - path: "notebooks/checkpoints/baseline_c16_b64_cr16x_*/best.pth"
      provides: "Verified Baseline 16x checkpoint"
    - path: "notebooks/checkpoints/resnet_c64_b64_cr4x_*/best.pth"
      provides: "ResNet 4x trained checkpoint"
    - path: "notebooks/checkpoints/resnet_c32_b64_cr8x_*/best.pth"
      provides: "ResNet 8x trained checkpoint"
    - path: "configs/sweep_resnet_ratios.yaml"
      provides: "Sweep configuration for reproducibility"
  key_links:
    - from: "configs/sweep_resnet_ratios.yaml"
      to: "scripts/train_sweep.py"
      via: "--sweep argument"
      pattern: "sweep.*yaml"
---

<objective>
Train missing ResNet models at 4x and 8x compression ratios to complete the experiment matrix.

Purpose: ResNet 16x already shows +2 dB over baseline - need 4x/8x to build complete rate-distortion curve and demonstrate ResNet advantage across all compression levels.

Output: Two trained ResNet checkpoints (4x at latent_channels=64, 8x at latent_channels=32) ready for evaluation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-final-experiments/06-CONTEXT.md
@.planning/phases/06-final-experiments/06-RESEARCH.md
@scripts/train_sweep.py
</context>

<tasks>

<task type="auto">
  <name>Task 0: Verify baseline checkpoints exist and are valid</name>
  <files></files>
  <action>
Verify that all required baseline checkpoints from Phase 4 exist and are loadable.

Run verification script:

```python
import torch
from pathlib import Path
import glob

# Known baseline checkpoints from STATE.md
BASELINE_CHECKPOINTS = {
    'baseline_4x': 'notebooks/checkpoints/baseline_c64_b64_cr4x_20260127_195355/best.pth',
    'baseline_8x': 'notebooks/checkpoints/baseline_c32_b64_cr8x_20260127_205741/best.pth',
    'baseline_16x': 'notebooks/checkpoints/baseline_c16_b64_cr16x_20260127_231730/best.pth',
}

# Known ResNet 16x checkpoint
RESNET_CHECKPOINTS = {
    'resnet_16x': 'notebooks/checkpoints/resnet_c16_b64_cr16x_20260128_003926/best.pth',
}

print("Verifying baseline checkpoints...")
for name, path in BASELINE_CHECKPOINTS.items():
    p = Path(path)
    if p.exists():
        size_mb = p.stat().st_size / (1024 * 1024)
        # Quick load test
        ckpt = torch.load(path, map_location='cpu', weights_only=False)
        psnr = ckpt.get('best_metrics', {}).get('val_psnr', 'N/A')
        print(f"  [OK] {name}: {size_mb:.1f} MB, PSNR={psnr}")
    else:
        print(f"  [MISSING] {name}: {path}")

print("\nVerifying ResNet 16x checkpoint...")
for name, path in RESNET_CHECKPOINTS.items():
    p = Path(path)
    if p.exists():
        size_mb = p.stat().st_size / (1024 * 1024)
        ckpt = torch.load(path, map_location='cpu', weights_only=False)
        psnr = ckpt.get('best_metrics', {}).get('val_psnr', 'N/A')
        print(f"  [OK] {name}: {size_mb:.1f} MB, PSNR={psnr}")
    else:
        print(f"  [MISSING] {name}: {path}")
```

Expected output:
- All 3 baseline checkpoints exist (4x, 8x, 16x)
- ResNet 16x checkpoint exists
- File sizes > 5MB (baseline) or > 50MB (ResNet)
- PSNR values match STATE.md (4x: 24.15, 8x: 21.34, 16x: 19.09)

If any checkpoint is MISSING, abort and report - Phase 4 outputs are required.
  </action>
  <verify>All 4 checkpoints verified: 3 baseline + 1 ResNet 16x, with PSNR values printed</verify>
  <done>Baseline checkpoints confirmed valid, ready to train ResNet 4x/8x</done>
</task>

<task type="auto">
  <name>Task 1: Create sweep configuration for ResNet 4x and 8x</name>
  <files>configs/sweep_resnet_ratios.yaml</files>
  <action>
Create YAML sweep config for ResNet at 4x and 8x compression:

```yaml
# Sweep configuration for ResNet at 4x and 8x compression ratios
# Run with: python scripts/train_sweep.py --sweep configs/sweep_resnet_ratios.yaml

defaults:
  model: resnet
  base_channels: 64
  learning_rate: 1e-4
  epochs: 35
  early_stopping_patience: 15
  batch_size: 16  # ResNet needs smaller batch on 8GB VRAM
  scheduler: plateau
  optimizer: adamw
  use_amp: true
  mse_weight: 0.5
  ssim_weight: 0.5

runs:
  # 4x compression: latent_channels = 256*256 / (16*16*4) = 64
  - latent_channels: 64
    batch_size: 8  # ResNet with 64 latent channels is memory-heavy

  # 8x compression: latent_channels = 256*256 / (16*16*8) = 32
  - latent_channels: 32
    batch_size: 12
```

Place in `configs/` directory (create if needed).
  </action>
  <verify>cat configs/sweep_resnet_ratios.yaml shows valid YAML with 2 runs</verify>
  <done>Sweep config exists with ResNet 4x (LC=64) and 8x (LC=32) configurations</done>
</task>

<task type="auto">
  <name>Task 2: Train ResNet at 4x and 8x using sweep script</name>
  <files>notebooks/checkpoints/</files>
  <action>
Execute training sweep for ResNet models:

```bash
python scripts/train_sweep.py --sweep configs/sweep_resnet_ratios.yaml --data-path D:/Projects/CNNAutoencoderProject/data/patches/metadata.npy
```

Training parameters per CONTEXT.md:
- 10% data (default via SARDataModule val_fraction handling)
- 35 epochs
- LR=1e-4 with ReduceLROnPlateau
- AdamW optimizer
- AMP enabled for VRAM efficiency

Monitor for:
- CUDA OOM: Reduce batch_size if needed (8 -> 6 for 4x, 12 -> 8 for 8x)
- Training progress: val_psnr should increase over epochs
- Checkpoint saving: best.pth created after first validation

Expected runtime: ~2-3 hours total (35 epochs each, two models)

Note: If training takes too long, can train 4x first (more memory-heavy), then 8x:
```bash
python scripts/train_sweep.py --model resnet --latent-channels 64 --base-channels 64 --batch-size 8 --epochs 35
python scripts/train_sweep.py --model resnet --latent-channels 32 --base-channels 64 --batch-size 12 --epochs 35
```
  </action>
  <verify>
Verify checkpoints exist:
```bash
ls -la notebooks/checkpoints/resnet_c64_b64_cr4x_*/best.pth
ls -la notebooks/checkpoints/resnet_c32_b64_cr8x_*/best.pth
```
Both should exist with file size > 50MB (ResNet model is ~22M params)
  </verify>
  <done>ResNet 4x and 8x checkpoints exist in notebooks/checkpoints/ with valid best.pth files</done>
</task>

<task type="auto">
  <name>Task 3: Quick validation of trained models</name>
  <files></files>
  <action>
Run quick evaluation on both new checkpoints to verify they trained correctly:

```bash
# Find the checkpoint paths dynamically using glob patterns
RESNET_4X=$(ls -d notebooks/checkpoints/resnet_c64_b64_cr4x_* 2>/dev/null | sort | tail -1)
RESNET_8X=$(ls -d notebooks/checkpoints/resnet_c32_b64_cr8x_* 2>/dev/null | sort | tail -1)

echo "ResNet 4x checkpoint: $RESNET_4X"
echo "ResNet 8x checkpoint: $RESNET_8X"

# Quick evaluation (limited samples)
python scripts/evaluate_model.py --checkpoint "$RESNET_4X/best.pth" --n-samples 500 --no-visualizations
python scripts/evaluate_model.py --checkpoint "$RESNET_8X/best.pth" --n-samples 500 --no-visualizations
```

Expected results:
- ResNet 4x: PSNR > 24 dB (similar to Baseline 4x at 24.15 dB or better)
- ResNet 8x: PSNR > 22 dB (improvement over Baseline 8x at 21.34 dB)

If PSNR is significantly lower, check training logs for issues.
  </action>
  <verify>Evaluation output shows PSNR values. ResNet 4x > 23 dB, ResNet 8x > 21 dB (reasonable for untrained-to-completion models)</verify>
  <done>Both ResNet checkpoints pass quick validation with PSNR above threshold</done>
</task>

</tasks>

<verification>
1. Baseline checkpoints verified: All 3 (4x, 8x, 16x) confirmed valid
2. Sweep config exists: `configs/sweep_resnet_ratios.yaml`
3. ResNet 4x checkpoint: `notebooks/checkpoints/resnet_c64_b64_cr4x_*/best.pth` (file > 50MB)
4. ResNet 8x checkpoint: `notebooks/checkpoints/resnet_c32_b64_cr8x_*/best.pth` (file > 50MB)
5. Quick eval confirms reasonable PSNR for both models
</verification>

<success_criteria>
- Baseline checkpoints verified as existing and valid
- Two new ResNet checkpoints trained and saved
- ResNet 4x achieves PSNR > 23 dB on validation
- ResNet 8x achieves PSNR > 21 dB on validation
- Training completed without OOM errors
- Models ready for systematic evaluation in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/06-final-experiments/06-01-SUMMARY.md`
</output>
